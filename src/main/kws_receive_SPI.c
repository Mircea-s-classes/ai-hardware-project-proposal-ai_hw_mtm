// Includes
//#include <stdlib.h>
#include <math.h>
//#include "arm_math.h"
#include "CMSDK_CM0plus.h"
#include "core_cm0plus.h"
#include "/net/redfox.ece.Virginia.EDU/isan2/users/bengroup/workspace/Trenton/ARM_IP/Split_KWS_Testbed/digital_top/BP200-BU-00000-r1p1-00rel0/software/common/retarget/uart_stdout.h"


// Constants
#define small_delay  __ISB
#define coreMMR_base_addr 0x4000B000
#define spi0_base_addr 0x4000C000
#define spi_sub_base_addr 0x4000A000
#define  SRAM_BASE_ADDR  0x20000000
#define HW32_REG(ADDRESS)  (*((volatile unsigned long  *)(ADDRESS)))
#define ispic_base_addr 0x40006000

#define NUM_TESTS 10
#define INPUT_SIZE 50
#define CONV_KERNEL_SIZE_X 5
#define CONV_OUTPUT_SIZE_X 46  // After applying 5x1 kernel to 50 input (valid padding)
#define FC_SIZE 32
#define OUTPUT_SIZE 1  // Output size for binary classification

int boot_done=0;
volatile int processing_ready=0;
volatile int counter;
float conv_output[CONV_OUTPUT_SIZE_X];  // Convolution output (1D)
volatile uint32_t rx_buffer[CONV_OUTPUT_SIZE_X];  // Buffer for all received tests
volatile int rx_index = 0;  // Index to track position in the buffer
uint32_t sram_addr;

void writeToMMR(uint32_t offset, uint32_t value)
{
    *(volatile uint32_t *)(coreMMR_base_addr + offset) = value;
}

// Small delay
void delay(int n) {
    counter = n;
    while (counter-- > 0);
}

void ISPI0_WRITE_Handler(void) {
	*(volatile int*) (ispic_base_addr+ 0x08) = 0x00000002; //Clear ISPI0 Write Interrupt
	*(volatile int*) (ispic_base_addr + 0x18) = 0; //Clear acknowledge
	uint32_t status = (*(volatile int*) (ispic_base_addr + 0x10));
	uint32_t instr = (status >> 24);
	uint32_t addr =  (status >> 16) & 0xFF;
        uint32_t rx_data = (*(volatile int*) (ispic_base_addr + 0x24 + 0x4*addr));

	//address 3 added by trenton
	if (addr == 0x3) {
	    rx_buffer[rx_index] = rx_data;
	    rx_index++;
	    if (rx_index >= CONV_OUTPUT_SIZE_X) {
		processing_ready = 1;
	    }
	    *(volatile int*)(ispic_base_addr + 0x18) = 1;
	}

}


// Sigmoid and ReLU activation functions 
float sigmoid(float x) {
    return 1.0f / (1.0f + expf(-x));
}

float relu(float x) {
    return (x <= 0) ? 0.0f : x; 
}


void receive_float_from_MCU1() 
{
    while (!processing_ready) 
	{
		//*(volatile int *) (spi_sub_base_addr + 0x4) = rx_buffer[rx_index-1];
		*(volatile int *) (spi_sub_base_addr + 0x4) = rx_index;
		__WFI();
    	}
	rx_index = 0;
	processing_ready=0;
	for (int i = 0; i < CONV_OUTPUT_SIZE_X; i++) 
		{
			conv_output[i] = *((float*)&rx_buffer[i]);
	    	}
}



void fully_connected_relu(float* input, float* weights, float* bias, float* output, int input_size, int output_size) {
    for (int i = 0; i < output_size; i++) {
        float sum = bias[i];  // Start with the bias for this output unit
        for (int j = 0; j < input_size; j++) {
            int weight_index = i + j * output_size;  // Calculate index for row-major (C-order) flattened weights
            sum += input[j] * weights[weight_index];  // Access weight from the flattened array
        }
        output[i] = relu(sum);  // Apply ReLU activation function
    }
}

void fully_connected_sigmoid(float* input, float* weights, float* bias, float* output, int input_size, int output_size) {
    for (int i = 0; i < output_size; i++) {
        float sum = bias[i];  // Start with the bias for this output unit
        for (int j = 0; j < input_size; j++) {
            int weight_index = i + j * output_size;  // Calculate index for row-major (C-order) flattened weights
            sum += input[j] * weights[weight_index];  // Access weight from the flattened array
        }
        output[i] = sigmoid(sum);  // Apply ReLU activation function
    }
}

int main(){
    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xfa11900d;

    //NVIC_EnableIRQ(0);
    //NVIC_EnableIRQ(1);
    //NVIC_EnableIRQ(5);  // ISPI0 READ
    NVIC_EnableIRQ(11); // ISPI0 WRITE
    //NVIC_EnableIRQ(10); // ISPI1 WRITE
    //NVIC_EnableIRQ(12); // ISPI1 READ
    //NVIC_EnableIRQ(13); // ISPI2 WRITE
    //NVIC_EnableIRQ(14); // ISPI2 READ
    //NVIC_EnableIRQ(6);  // ISPI3 WRITE
    //NVIC_EnableIRQ(7);  // ISPI3 READ
    *(volatile int*) (spi_sub_base_addr + 0x18) = 0x3; // Unmask both interrupts
    *(volatile int *) (spi_sub_base_addr) = 0x1; // Tells CAC we're ready to receive data
    //*(volatile int*) (ispic_base_addr+ 0x00) = 0x40100000; //set the pul and pdl (hex 100) and the enables to 0 to match NodeCs
    *(volatile int*) (ispic_base_addr+ 0x00) = 0x3FF00009; //set the pul and pdl (hex 100) and the enables to 1 to match NodeCs
    *(volatile int*) (ispic_base_addr+ 0x04) = 0x2F004000; //ACBW=2, all neighbors valid, address is (AC=0, X=0,Y=0), bridge_write_en is 1, all else is 0

    // Weights and biases
    float fc_bias[FC_SIZE] = {0.015552839, -0.17178693, 0.11197195, 0.043621097, -0.3451302, -0.20213829, 0.37678856, -0.036332138, -0.52055764, 0.12400154, -0.3823083, 0.35961667, -0.06506643, 0.6132683, 0.087261915, 0.1788521, -0.18069413, 0.24049568, -0.4230267, 0.24086891, 0.51180816, 0.60193354, -0.07280418, -0.5982362, -0.4548619, -0.12566628, 0.6379143, -0.47914124, -0.69296074, -0.01364722, -0.19861951, -0.2959348};
    float output_weights[CONV_OUTPUT_SIZE_X * FC_SIZE]={-0.776418, -0.5173826, 0.905674, -0.8933945, 1.211346, 0.78826505, 0.36401024, 1.0675632, 1.9950278, 0.48088977, -0.476064, -0.9732262, -0.7465058, -0.63055474, 0.53727704, 0.19211727, 0.48108476, 0.32591337, -1.0289476, -1.0085154, -0.63484865, -0.89671874, 0.4049235, 1.1430281, -0.34898043, 1.3494916, -1.6063638, 1.6014642, 1.8383322, 0.46262372, 0.13655195, 1.4983058};  // output weights (FC2)
    float output_bias[OUTPUT_SIZE] = {-0.1681932};
    float fc_weights[CONV_OUTPUT_SIZE_X * FC_SIZE]={-0.24892586, 0.26310155, -0.22861691, -0.0073079853, -0.10992607, -0.035216987, 0.2483696, -0.0368414, -0.044649053, -0.50272477, 0.11067421, -0.46452913, 0.020816134, -0.10901419, 0.21183027, 0.05104911, -0.16042165, 0.3099106, 0.078744285, -0.42892644, -0.20339552, -0.03715534, 0.020297432, 0.07877933, 0.318259, -0.12653032, -0.15598013, -0.06524411, -0.04848823, 0.1002696, -0.08471909, -0.75114137, -0.29148465, 0.08707217, -0.080530584, 0.24584946, -0.16381192, -0.1611025, 0.07101807, 0.18240774, -0.123522796, 0.22948174, 0.21300451, 0.15444833, -0.3247028, 0.12219575, -0.16464049, -0.39934328, -0.060732428, -0.17359138, -0.043874633, -0.033829875, 0.23554868, -0.15219088, 0.23968665, 0.20073679, -0.045181748, -0.6525825, -0.09017798, -0.16526926, -0.022437003, -0.33009312, 0.01841237, -0.054771207, -0.19453913, 0.029071372, 0.012679908, -0.49309647, 0.03414879, 0.10235672, -0.29022953, 0.030986724, -0.32387498, 0.45961964, 0.03517705, 0.058323365, 0.06864241, 0.103534214, -0.3622567, -0.47575513, 0.3169248, -0.25631642, 0.27079108, -0.044871565, 0.37932047, 0.16752137, -0.24445975, -2.5500062, 0.32053465, -0.22163202, 0.08725595, -0.17182148, -1.034955, 0.29629797, -0.25361297, -0.20271266, 0.054246187, -0.20598033, 0.061690275, -0.16231582, -0.75186616, -0.74655205, 0.035467345, -0.4469807, -0.7998999, -0.16543797, 0.11165979, -0.036130376, 0.1778743, 0.007254174, -0.26433814, -0.06478301, 0.06858995, -0.046435658, -0.56738764, -0.3896476, 0.11222024, 0.1270538, -0.108935215, -0.353019, 0.37053886, -0.16006823, 0.21616231, -0.3329909, -1.1403035, 0.10359213, -0.15906812, -2.652681, 0.34285888, -0.24823926, 0.09977667, -0.12056079, -0.115612276, 0.19694234, -0.00015896492, 0.14808115, 0.45294726, 0.38587573, 0.12132433, -0.405844, 0.35603827, -0.20428093, -0.20117253, 0.39057365, -0.08426701, 0.15960488, -0.07951923, 0.27181762, 0.1488, 0.3075242, -0.05433215, -0.153344, -0.21923593, 0.3482229, 0.2467807, -1.0863692, -1.6420645, -0.608482, -0.053990137, 0.2689893, -0.07349769, 0.14767833, -0.09928481, -0.5339323, 0.11165744, -0.046145078, 0.069527656, -0.40362486, -0.4495029, 0.2037434, 0.06705877, 0.08487771, -0.25509444, 0.2929702, 0.006387312, 0.3487481, 0.17730959, 0.06719128, -0.038199026, -0.34941903, 0.26516476, -0.14025013, -0.26565972, 0.22134636, 0.12932011, 0.07248882, -0.033026878, -0.74788934, -0.47585592, -0.030719284, -0.28578377, -0.36508045, -0.009397403, 0.20979731, -0.025217233, -0.2079545, 0.025640022, -0.18146826, 0.36058366, 0.021388764, 0.5106064, -0.12170195, -0.8535368, -0.45764405, 0.46163583, 0.04327086, -0.042445745, 0.096871495, 0.35220888, -0.24175121, -0.13017756, 0.16886686, 0.37896872, -0.3794639, 0.07778824, -0.51991403, -0.02489569, -0.6303058, 0.059854623, -0.90915084, 0.35819644, -0.18536076, -0.23320347, -0.08432849, 0.57039636, -0.22993782, -0.305194, 0.15024701, -0.11165523, 0.335085, 0.25668287, -0.0186572, -0.43082583, -0.12335391, 0.3109234, 0.014057437, 0.27066866, -0.70012707, -0.11975116, -0.010533547, -0.29993397, 0.3216745, -0.2090812, 0.095331304, 0.1921671, -0.13737302, -0.001633383, -0.080799535, 0.22590321, -0.2230077, -1.0268129, 0.44388384, 0.16828191, -0.03307282, 0.08069883, -0.7223098, 0.19144784, -0.36544824, 0.009626945, 0.17242667, -0.5756614, -0.59839773, -0.368973, -0.14721744, -0.12579669, 0.19516392, -0.0571866, -0.21134022, 0.667665, -0.3585156, -0.043328952, 0.1955664, -0.0038756346, -0.2906335, 0.12962559, -0.6062023, 0.33255714, 0.059730526, 0.86275214, -0.44826737, 0.6023177, -0.23655002, 0.17056589, -1.08093, -1.4101048, 0.32364482, -0.2232334, -0.16753855, 0.4216826, 0.060221292, 0.048440713, -0.37466034, 0.020941334, 0.19684155, -0.06313131, -0.28365505, -0.6791436, -0.024752542, -0.3691034, 0.007553949, -0.3278695, 0.13124135, -0.006996529, -0.066360526, 0.40126324, -0.07735492, -0.118898794, 0.19981632, 0.092081755, -0.35739294, 0.21523927, -1.2819241, 0.3386475, -0.04018593, -0.21296217, -0.6887571, -1.4726752, 0.02838678, -0.32146707, 0.16691881, -0.13466837, 0.15925182, -0.6460864, -0.42079526, -0.34685624, -0.41842476, -0.047131017, -0.4299314, 0.27742815, 0.12927349, 0.136063, 0.18234608, -0.4085058, -0.049372155, -0.33994085, 0.21479364, 0.2055492, -0.31626862, -0.01720281, 0.33518246, -0.5694768, -0.27964976, -0.12147615, -0.055276226, -0.11898336, 0.002736062, 0.4232108, 0.22885361, 0.13856019, 0.22898042, -0.2573449, -0.5418573, -0.012539313, 0.3725149, 0.36854252, 0.09395085, -0.00952818, -0.36872625, 0.16945344, -0.4074798, -0.5101612, 0.010955544, 0.44795907, 0.43342152, 0.061280627, -0.115494885, 0.21013527, 0.042385776, -0.1033993, 0.4085132, -0.5115666, -0.11693182, -0.0841226, -0.051224604, -0.08887364, -0.44698793, -0.08212145, -0.14335898, -0.10264103, -1.0091586, -0.4901694, 0.44039088, 0.12580146, 0.47134352, -0.050156556, 0.08115402, -0.12566395, 0.024024151, -0.55429757, 0.29163975, -0.10334515, 0.38889495, 0.49889106, -0.19816017, 0.009667904, 0.037341584, 0.1703934, 0.44341564, 0.12279128, 0.19941008, -0.123824194, 0.1393226, 0.10466576, -0.25007507, 0.11908297, 0.0767634, -0.025856677, -0.7948248, 0.06877974, -0.07944663, -0.037426706, 0.20233318, -0.12779419, 0.40887547, -0.29826266, -0.5982884, 0.123352274, -0.11334995, 0.22812687, 0.45299748, -0.2680905, -0.040022995, -0.15796176, 0.23208769, -0.008312044, 0.14609483, -0.45448646, -0.058835126, -0.46275824, -0.36469737, -0.22448994, 0.14015967, -0.17850354, 0.09233062, -0.47200418, 0.17438608, 0.04665807, 0.5189641, 0.4057944, -0.45415634, 0.3366171, 0.2469794, 0.1999987, 0.35640308, -0.14191379, 0.062091805, -0.15065366, 0.3579811, 0.18621512, 0.30501738, -0.16673732, -0.2305212, 0.49984163, 0.23517191, -0.064491704, -1.4468178, -0.7631058, 0.09055227, 0.023891129, -0.00016063612, 0.40473518, -0.23212025, 0.13578908, 0.20527707, 0.24714188, 0.11983493, -0.032452337, -0.014390777, 0.031090409, -0.3979372, -0.077421755, 0.10180593, 0.5377106, -0.60989803, 0.31398928, -1.0354097, -0.0105927605, -0.12453983, -0.2352168, 0.05505801, -0.1302615, 0.41894838, -0.40020454, -0.08271448, 0.26315543, 0.1298775, 0.06037687, -0.080582514, -0.66321623, 0.05960851, -0.13097811, 0.66746587, 0.24324493, 0.27437338, 0.047231145, 0.37084207, 0.1505869, -0.1850043, -0.17334366, 0.07919874, -0.6709923, -0.3963128, 0.57649004, -0.23198774, -0.034225754, -0.5771369, 0.17180501, -0.1919047, -1.7268289, 0.079234466, 0.119359806, 0.49028847, 0.5033625, 0.22316419, 0.68629014, -0.23089433, 0.86510175, 0.03984572, -0.05641629, 0.2647089, 0.009173978, -0.08250182, -0.0062742652, -0.270126, 0.10515573, 0.09332378, -0.3086881, 0.2927858, 0.23396835, 0.55781823, 0.34349686, 0.58840746, 0.26023674, 0.5389788, 0.23707642, 0.20109653, -0.022956695, -0.02667338, -0.2529327, -0.120534815, -0.25252467, 0.13056932, -0.017018827, -0.5457815, -0.36255163, -0.44964477, -0.71279263, -0.17883082, -0.20179416, 0.13304946, -0.36750734, -0.29188702, -0.1918838, 0.044944726, -0.13115245, -0.052709613, -0.21236081, -0.2504802, -0.18225212, -0.012837227, 0.028286526, -0.30985186, -0.23770164, 0.27263796, 0.12041845, -0.13045506, 0.22759484, 0.06069278, 0.24416296, -1.3718218, 0.030076401, 0.06446558, 0.09542268, -0.15172376, -0.21876699, 0.14707284, 0.0561752, 0.0021152026, -0.15758827, 0.4619167, 0.10122569, -0.7114496, 0.4236029, 0.20705669, -0.71290636, 0.112798005, 0.09247579, 0.03564616, 0.118305266, 0.59624183, 0.3694149, 0.22828954, 0.27552265, 0.42185327, -0.0986888, -0.73308, 0.053439304, -0.03911911, 0.109495215, -0.48294234, -0.03657369, -0.4569971, -0.12372776, -0.6098021, -0.41199502, 0.103257515, -0.3400795, -0.39162773, -0.21030049, 0.19487691, 0.3359339, -0.36680725, 0.060413413, -0.292288, 0.15670912, 0.12547044, -0.3578806, -0.72376955, 0.09759217, 0.45664683, 0.4163811, -0.41633728, 0.22960676, 0.14791533, 0.14631046, 0.35328406, -0.14901623, -0.11695007, 0.14786899, 0.35624376, 0.23070537, -0.25627878, 0.046660528, -0.3540179, -0.52609235, -0.9544847, 0.2094602, -0.014378235, -0.34762242, -0.12540625, 0.45077035, 0.5545037, -0.119041875, -0.37535045, 0.012272043, -0.1077494, -0.72738326, -0.008726452, 0.063061416, -0.6991654, -0.24293296, -0.33003742, -0.5398823, -0.19069935, 0.3185989, -0.42565623, 0.69441587, -0.4335371, 0.016166337, 0.067563206, -0.119789906, -0.15992522, -0.38580152, 0.2624303, -0.48261654, 0.51936686, -0.39625767, 0.12919964, -0.3325786, -0.28291163, -0.14258741, 0.10368553, 0.060003716, 0.17909656, 0.22589284, 0.41682526, -7.5063566e-05, 0.014007964, 0.2520506, 0.35369828, 0.15851778, -0.14357673, 0.38412946, 0.1532385, 0.30841017, 0.13551293, -0.21115966, -0.22711478, 0.11456331, -0.12929383, 0.04669577, 0.21763057, -0.53160733, -0.50718826, -0.09330115, -0.51072735, -0.55018306, 0.35892472, 0.29330835, -1.400313, -0.6364599, 0.15088949, 0.12732157, 0.09122661, -0.3831817, 0.02854348, 0.44027627, -0.07130715, 0.2836074, -0.15670274, -0.38609746, -1.040071, -0.19915462, -0.16411117, 0.2236232, 0.31025723, 0.22833756, 0.33936018, 0.025965316, 0.23130001, -0.05602451, 0.1548406, -0.16348262, -0.51681864, 0.30109847, 0.24124432, 0.5300526, 0.49701902, -0.41322288, 0.2876479, -0.483332, -0.5977884, -1.1821152, -0.35863775, -0.16715038, -0.37461853, 0.16701461, -0.118990496, 0.51431924, 0.5240834, -0.32881823, 0.60364264, -0.3824475, 0.52372587, 0.46971062, -0.11476344, -0.19042082, -0.27079675, 0.10895311, 0.31167695, 0.07075735, -0.015099342, 0.40005538, -0.023136249, 0.23923796, -0.14241755, -0.018272264, 0.3635701, -0.32943818, 0.27328774, -0.4165791, -0.29103205, 0.3048559, 0.028597742, 0.17510013, -0.21553169, -0.061409306, 0.41622156, -0.0151271885, 0.48732603, -0.0077939583, -0.071897104, 0.1801199, -0.12398943, -0.22962601, 0.5992237, -0.44264695, 0.057050496, -0.05364173, -0.82087207, -0.3479344, -0.35431597, -1.1007339, 0.56076247, 0.23992495, 0.03416505, 0.1749647, 0.46984497, 0.4800173, 0.30387276, -0.09312904, 0.26668268, 0.41012672, 0.19804683, -0.21241789, -0.34656644, 0.880394, 0.17838337, 0.17608026, -0.2835989, -0.03521909, 0.20148651, -0.28375086, -0.31477308, -0.26945114, 0.36600435, 0.26782382, -0.5719926, -0.777853, 0.4670567, -0.31567878, -0.03876424, -0.2101924, -0.79325676, -0.3324406, -0.5591758, -0.30857325, -0.06305451, -0.0058171614, 0.40295312, 0.13125888, 0.14635403, -0.5209635, -0.09023075, -0.15767168, 0.41680503, -0.16750354, -1.3805889, -0.14199658, -0.014571076, 0.13375787, 0.3488677, -0.04135044, 0.1005349, 0.033205118, -0.031706244, 0.59865063, 0.19439366, 0.47986075, 0.07629812, -0.007444982, 0.46499237, 0.79209244, -0.029002644, 0.27594668, 0.46936053, -0.05748228, -0.45080718, 0.14078517, -0.29255456, -0.98364025, 0.36824045, 0.40817678, -0.26112872, 0.09193543, -0.15065098, -0.2504713, -0.19025326, 0.30444673, -0.53814894, -0.35628304, -0.20705184, 0.10114051, -0.21260048, 0.37564477, 0.05351124, -0.23467183, 0.2739638, -0.2908949, -0.002623894, 0.28531912, -0.5352483, 0.40711316, -0.050240077, -0.12962824, -0.09416666, -0.008772438, 0.06608802, 0.3904821, 0.26586697, -0.23232237, 0.5649871, -0.12260297, 0.42536995, -0.47316045, 0.4453146, -0.028143462, -0.25935987, -0.3050379, 0.50527346, -0.055905573, -0.49804348, 0.07609067, 0.30367342, -0.17019297, -0.60594714, 0.49011394, -0.6813313, -0.46110404, -0.32741624, -0.20753145, 0.4756173, -0.096614316, -0.23758191, -1.3657391, -0.44989243, 0.01064605, -0.7941746, -0.25502405, -0.2258874, 0.036356166, -0.23775882, 0.19485883, 0.1891348, 0.57284164, 0.17596382, -0.02832831, -0.3626194, -0.083555125, 0.16027893, 0.09521555, -0.723145, 0.17687269, -1.0089742, 0.56284827, -0.3097575, -0.30451673, -0.40755746, 0.08267324, -0.26668602, -0.29429427, 0.60615903, 0.43917876, -0.56043845, -0.81777924, 0.07538453, -0.23901115, -0.34394586, -0.11731878, -0.12295061, -0.59448516, 0.2783487, -0.9135516, 0.7271525, 0.41897967, -0.22550626, -0.101388484, 0.52284616, 0.34106675, -0.2949691, 0.7734814, 0.5108695, -0.40283945, 0.27317166, 0.4570652, 0.028674474, -0.48269117, 0.6238204, -0.023821823, -0.48898354, -0.14582261, -0.24683818, 0.41663182, 0.21810454, -0.08959515, 0.0054208846, -0.017274737, -0.4612813, -0.38371262, 0.6172435, -0.18444455, 0.32075247, 0.31159517, 0.2015374, 0.06916593, 0.13103803, 0.21415547, 0.064649105, 0.5594055, 0.23282547, -0.72744787, 0.13634606, 0.06834321, 0.39800927, -0.28547356, 0.18674669, 0.6032481, 0.94726855, 0.25330874, 0.21379368, -0.14596951, 0.47569412, 0.7562498, -0.27101246, 0.44117525, 0.2115521, 0.4380716, 0.23499519, 0.5559756, 0.063275926, -0.8678067, 0.18139659, -0.6216779, -0.005092146, -0.25572065, 0.4706467, 0.2888164, -0.26257288, 0.032134484, -0.55783796, 0.46843436, 0.07530841, -0.46006072, -0.11042505, -0.10936136, -0.09428596, -0.12838581, 0.19079447, 0.47377324, -0.27603045, -0.10970876, -0.14637555, -0.10814999, 0.12015158, 0.7540729, -0.4043417, 0.52496123, 0.1945914, -0.58552414, 0.55513936, 0.52279097, -0.11222818, -0.3080725, 0.37852043, 0.38023612, 0.106999636, 0.18778633, -0.23044816, -0.44995126, -0.2406162, -0.6303665, -0.6006806, 0.63403064, 0.4973261, -0.83412987, -0.62363, -0.030346008, 0.6404145, -0.4831448, -0.4820815, -1.341884, -1.0698645, 0.19406395, 0.35972714, -0.2430106, -0.13692817, 0.7291839, 0.2175709, 0.5070474, 0.16839337, -0.97518134, 0.13358775, -0.017203556, 0.04835509, -1.0981401, 0.13007206, -0.7006659, 0.51662004, 0.36944216, 0.52134573, 0.113168165, 0.4129512, 0.13247243, -0.12776928, -0.068163335, -0.33306333, -0.7068607, -0.08937625, -0.11471535, 0.055005085, -0.6820627, -0.4256151, -0.115993544, -0.25397882, 0.03912368, 0.0058532394, -0.120825864, -0.22455941, 0.2959864, -0.01699027, -0.5826621, -0.13033494, -0.21037765, 0.035577845, -0.09318268, -0.029964166, -0.06921136, 0.103782825, 0.5476246, -0.029705796, -0.011055533, 0.09217434, 0.7046102, -0.09481904, -0.16320127, -0.6053953, 0.16389163, 0.011570787, -0.3490152, -0.060995728, -0.30684182, -1.4180305, -0.5509126, 0.17692392, -0.20341563, 0.7476288, -0.12531151, 0.048072897, -0.27674484, -1.0942335, -0.2552369, -0.6203986, -0.8284798, 0.28845757, 0.14471963, -0.9305322, 0.33594266, 0.18382946, -0.6233641, 0.1685026, 0.10384369, 0.9104113, 0.14452912, -0.02799013, -0.44439062, 0.015109048, -0.07068049, 0.03197037, -0.23166642, -0.20410183, -0.50476223, -0.6598406, 0.49711865, 0.16261941, 0.30789146, 0.39671415, 0.35846967, -1.131696, -1.6681554, -0.22908431, -0.012754636, 0.05828199, 0.027515566, 0.35451806, 0.19949491, 0.034763936, -0.062070463, 1.1742878, 0.30712777, 0.14925829, -0.99516654, 0.08780709, 0.58894557, 0.450444, -0.3878972, 0.18598285, -0.15551662, -0.0249327, -0.031977553, 0.009065304, 0.9037317, -0.5487867, 0.165894, -0.2294469, -0.16078982, -0.4223332, 0.39348182, 0.57118213, -0.36240712, -0.82273006, 0.12629583, 0.2095752, -0.061297566, -0.3908633, 0.2488572, -0.23795016, 0.43518957, -0.008850778, -0.060850598, -0.3283886, -0.14599323, -0.6719956, -1.1944922, -0.31211036, -0.3205303, -0.4344229, 0.17528248, 0.085123286, 0.29333407, 0.1097826, -0.4389141, -0.48896894, -0.13144241, -0.7204557, 0.0051667867, 0.28212836, -0.29391313, -0.71907806, 0.06125102, -0.045692615, -0.09836005, 0.5353639, -0.30018577, 0.1943965, -0.19443706, -0.22067596, -0.13853472, -0.051625565, -0.5828818, 0.8305533, -0.35647026, 0.038973317, -0.5985635, 0.5446988, -1.3616586, 0.020294238, -0.45328662, 0.47089332, -0.68401134, 0.31367505, 0.17134415, -0.09662739, -0.13618863, 0.084298484, -0.74430776, 0.38180587, -0.4024156, -0.10596022, -0.045477256, -0.8079561, -0.5674968, 0.17126909, -0.40550143, -0.8746509, 0.026611326, -1.0946301, 0.12740879, -0.14761871, 0.27492553, 0.26968014, -0.27059928, 0.0475627, 0.34099683, 0.19683857, -0.18455264, -0.74829, 0.8684088, 0.3858979, -0.31676596, -0.088198096, -0.27308005, -0.120990984, -0.1196441, 0.45299017, -0.9360492, -0.23062699, -0.7411416, -0.1438049, -0.67414916, 0.24744287, -0.6580803, -0.03971423, 0.16404796, 0.08508905, -0.406269, 0.5421663, -0.8725898, -0.12893397, -0.27753183, -0.28569213, 0.69434184, -0.07079337, 0.29283345, -0.41968834, -1.4183993, -0.61988515, -0.14310956, 0.31807518, 0.30122325, 0.17442398, -1.0778874, 0.2844533, 0.9713342, -0.40816772, 0.2038243, -0.01836327, 0.2255363, 0.49604496, -0.09473474, -0.027038734, -0.58909655, 0.06994728, 0.1212756, -0.21834162, -0.15493786, 0.30588076, -0.266139, -1.0451096, -0.39300206, 0.17008762, -0.3572019, -0.3601308, 0.22187433, -0.60883826, 0.4693456, -0.015050461, 0.54911685, -0.52921, -0.113303885, -0.50320596, -0.49562237, 0.33276197, -0.12991114, 0.14146933, -0.026768275, -0.16663587, 0.08398998, -0.14661504, 0.110493965, -0.20362721, 0.9952335, 0.13756834, -0.38432962, 0.3373223, 0.09645257, -1.8358914, -0.44566107, 0.04321599, 0.084058076, -0.7767328, 0.10158703, 0.3690667, -0.33495912, 0.57809204, 0.3881456, -0.6550876, -0.92560303, 0.06392756, 0.027171858, 0.38091797, -0.2866768, 0.48727533, -1.0758259, 0.4391359, -0.44762135, -0.6133948, -0.4176439, -1.0177238, -0.24401937, -0.46184915, -0.51264, -0.5443974, 0.6936145, 0.04147718, 0.22943333, 0.5386473, -0.43085682, 0.2525521, -0.101317205, -0.21449709, -0.66142505, 0.2983286, -1.3213371, -0.3313241, -0.33485073, -0.2842013, -0.2994655, 0.52143, 0.33344615, 0.31743962, -0.16249399, -0.24790126, -0.06321174, 0.39626125, -0.6375924, 0.07182521, 0.037402246, -0.41840646, -0.7117579, 0.33847472, 0.17212132, -0.34455696, 0.34319684, 0.18731129, -0.20015603, -0.19649154, -0.10627657, 0.37766638, -0.281751, -0.6656914, 0.35257265, 0.5926707, 0.50589305, -0.030083712, -0.30962282, 0.16296624, -0.09704789, -0.3157255, -0.39672127, -0.3942286, 0.32377207, -0.52042437, -1.0182014, 0.17040904, -0.7389999, -0.2922631, 0.6008643, -0.4219099, 0.3978255, 0.26976058, -0.2887788, 0.28754297, -0.24618652, 0.21038616, -0.13952255, -0.2427965, -0.5719275, -0.68276614, 0.23353851, 1.1444917, 0.2292177, 0.50072587, 0.4114765, 0.17677593, -0.83680063, -0.6111005, 0.2866481, -0.5718748, -0.15841815, -0.2134407, -0.0072730803, -0.3795509, -0.51876056, -0.58725315, 0.4750796, 0.6304832, -0.21996175, -0.6832629, 0.8798393, 0.07278263, 0.21751852, 0.6384074, -0.64438975, -0.38337892, 0.40475625, -0.09729791, 0.104932904, -1.0003563, 0.7394751, -0.076144196, 0.11250239, 0.30484304, -0.24887387, 0.29324248, -0.7497817, 0.3923589, 0.05027825, -0.07765971, 0.7092722, -0.72605556, 0.05549513, 0.115438};

    // Output arrays
    float fc_output[FC_SIZE];
    float output[OUTPUT_SIZE];
	rx_index=0;
	while(1)
		{
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d1;
		    receive_float_from_MCU1();
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d2;
		    // Perform fully connected layer with ReLU
		    fully_connected_relu(conv_output, fc_weights, fc_bias, fc_output, CONV_OUTPUT_SIZE_X, FC_SIZE);
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d3;
		    // Perform fully connected layer with Sigmoid
		    fully_connected_sigmoid(fc_output, output_weights, output_bias, output, FC_SIZE, OUTPUT_SIZE);
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d4; 
		    *(volatile int *) (spi_sub_base_addr + 0x4) = *(uint32_t*)&output[0];
		
		delay(1000);
		*(volatile int*) (ispic_base_addr + 0x14) = *(uint32_t*)&output[0]; //data
		*(volatile int*) (ispic_base_addr + 0x34) = 0x00000009; //routing_path_in_0_0 = 00001001 or ac0, x=1, y=1
		*(volatile int*) (ispic_base_addr+ 0x0C) = 0x1A050003; //Instruction 02 (normal write) to address 3 but from fourth direction
		*(volatile int*) (ispic_base_addr+ 0x0C) = 0x1A050002; //Remove Flag 
		delay(1000);

		// -------------------- SEND DATA --------------------
		//*(volatile int*) (ispic_base_addr + 0xA4) = *(uint32_t*)&output[0]; //data
		//*(volatile int*) (ispic_base_addr + 0xC4) = 0x00000009; //routing_path_in_0_0 = 00001001 or ac0, x=1, y=1
		//*(volatile int*) (ispic_base_addr+ 0x9C) = 0x1A050003; //Instruction 02 (normal write) to address 3 but from fourth direction
		//*(volatile int*) (ispic_base_addr+ 0x9C) = 0x1A050002; //Remove Flag 
   		//*(volatile int *) (spi_sub_base_addr + 0x4) = 0xFFFFFFFF;
		}
    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xFFA11BAD; 
    return 0;
}

