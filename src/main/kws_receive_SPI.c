// Includes
//#include <stdlib.h>
#include <math.h>
//#include "arm_math.h"
#include "CMSDK_CM0plus.h"
#include "core_cm0plus.h"
#include "/net/redfox.ece.Virginia.EDU/isan2/users/bengroup/workspace/Trenton/ARM_IP/Split_KWS_Testbed/digital_top/BP200-BU-00000-r1p1-00rel0/software/common/retarget/uart_stdout.h"


// Constants
#define small_delay  __ISB
#define coreMMR_base_addr 0x4000B000
#define spi0_base_addr 0x4000C000
#define spi_sub_base_addr 0x4000A000
#define  SRAM_BASE_ADDR  0x20000000
#define HW32_REG(ADDRESS)  (*((volatile unsigned long  *)(ADDRESS)))
#define ispic_base_addr 0x40006000

#define NUM_TESTS 10
#define INPUT_SIZE 50
#define CONV_KERNEL_SIZE_X 5
#define CONV_OUTPUT_SIZE_X 46  // After applying 5x1 kernel to 50 input (valid padding)
#define FC_SIZE 32
#define OUTPUT_SIZE 1  // Output size for binary classification

int boot_done=0;
volatile int counter;
float conv_output[CONV_OUTPUT_SIZE_X];  // Convolution output (1D)
volatile uint32_t rx_buffer[CONV_OUTPUT_SIZE_X];  // Buffer for all received tests
volatile int rx_index = 0;  // Index to track position in the buffer
uint32_t sram_addr;

void writeToMMR(uint32_t offset, uint32_t value)
{
    *(volatile uint32_t *)(coreMMR_base_addr + offset) = value;
}

// Small delay
void delay(int n) {
    counter = n;
    while (counter-- > 0);
}

void spi0_init(void) {
  *(volatile int *) spi0_base_addr= (0 << 8) | 	// serial clock rate
				(0 << 7) | 	// SCLK out clock phase
				(0 << 6) | 	// SCLK out clock polarity
				(0 << 4) | 	// SPI vs. TI format, etc.
				(8 - 1 << 0);	// DATA LENGTH - 1 (i.e., 15 -> 16 bit data)

  *(volatile int *) (spi0_base_addr+ 4) = (0 << 3) | 	// slave-mode output disable. Does not apply to master mode
				(0 << 2) | 	// sets SSP to master mode
				(0 << 1) | 	// disable SSP until config complete
				(0 << 0); 	// loopback mode = false
  *(volatile int*)( spi0_base_addr+ 0x10) = 2;		// defines clock division factor by which SSPCLK is divided
  *(volatile int*) (spi0_base_addr+ 4) |= (1 << 1);
  *(volatile int*)(spi0_base_addr + 0x14) = (1 << 2);
  return;
}

void ISPI3_WRITE_Handler(void) {
	*(volatile int*) (ispic_base_addr+ 0x08) = 0x00000080; //Clear ISPI3 Write Interrupt
	*(volatile int*) (ispic_base_addr + 0xA8) = 0; //Clear acknowledge
	uint32_t status = (*(volatile int*) (ispic_base_addr + 0xA0));
	uint32_t instr = (status >> 24);
	uint32_t addr =  (status >> 16) & 0xFF;
        uint32_t rx_data = (*(volatile int*) (ispic_base_addr + 0xB4 + 0x4*addr));

	HW32_REG(ispic_base_addr + 0xA4) = sram_addr;

	if (addr == 0x0)	{
		HW32_REG(sram_addr) = rx_data;
		HW32_REG(ispic_base_addr + 0xA4) = 0xe1100000;
		sram_addr += 0x4;
		*(volatile int*) (ispic_base_addr + 0xA8) = 1;
	}
	else if (addr == 0x1) {
		HW32_REG(sram_addr - 0x4) = rx_data;
		HW32_REG(ispic_base_addr + 0xA4) = 0xe1100000;
		*(volatile int*) (ispic_base_addr + 0xA8) = 1;		
	}
	else if (addr == 0x2) {
	   if (rx_data == 0x3) {
		   boot_done = 1;
	   } 
	   else if (rx_data == 0xde1) {
		sram_addr -= 0x4;
	   }		
	}
	//addrtess 3 added by trenton
	else if (addr == 0x3) {
	    rx_buffer[rx_index] = rx_data;
	    rx_index++;
	    *(volatile int*)(ispic_base_addr + 0xA8) = 1;
	}

}


// Sigmoid and ReLU activation functions 
float sigmoid(float x) {
    return 1.0f / (1.0f + expf(-x));
}

float relu(float x) {
    return (x <= 0) ? 0.0f : x; 
}


void receive_float_from_MCU1() 
{
    while (rx_index < CONV_OUTPUT_SIZE_X) 
	{
		__WFI();
		*(volatile int *) (spi_sub_base_addr + 0x4) = rx_buffer[rx_index-1];
    	}
	rx_index = 0;
	for (int i = 0; i < CONV_OUTPUT_SIZE_X; i++) 
		{
		conv_output[i] = *((float*)&rx_buffer[i]);
	    	}
}



void fully_connected_relu(float* input, float* weights, float* bias, float* output, int input_size, int output_size) {
    for (int i = 0; i < output_size; i++) {
        float sum = bias[i];  // Start with the bias for this output unit
        for (int j = 0; j < input_size; j++) {
            int weight_index = i + j * output_size;  // Calculate index for row-major (C-order) flattened weights
            sum += input[j] * weights[weight_index];  // Access weight from the flattened array
        }
        output[i] = relu(sum);  // Apply ReLU activation function
    }
}

void fully_connected_sigmoid(float* input, float* weights, float* bias, float* output, int input_size, int output_size) {
    for (int i = 0; i < output_size; i++) {
        float sum = bias[i];  // Start with the bias for this output unit
        for (int j = 0; j < input_size; j++) {
            int weight_index = i + j * output_size;  // Calculate index for row-major (C-order) flattened weights
            sum += input[j] * weights[weight_index];  // Access weight from the flattened array
        }
        output[i] = sigmoid(sum);  // Apply ReLU activation function
    }
}

int main(){
    sram_addr = 0x20007000;
    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xfa11900d;

    //NVIC_EnableIRQ(0);
    //NVIC_EnableIRQ(1);
    //NVIC_EnableIRQ(5);  // ISPI0 READ
    //NVIC_EnableIRQ(11); // ISPI0 WRITE
    //NVIC_EnableIRQ(10); // ISPI1 WRITE
    //NVIC_EnableIRQ(12); // ISPI1 READ
    //NVIC_EnableIRQ(13); // ISPI2 WRITE
    //NVIC_EnableIRQ(14); // ISPI2 READ
    NVIC_EnableIRQ(6);  // ISPI3 WRITE
    //NVIC_EnableIRQ(7);  // ISPI3 READ
    *(volatile int*) (spi_sub_base_addr + 0x18) = 0x3; // Unmask both interrupts
    *(volatile int *) (spi_sub_base_addr) = 0x1; // Tells CAC we're ready to receive data
    *(volatile int*) (ispic_base_addr+ 0x00) = 0x40100009; //set the pul and pdl (hex 100) and the enables to 1 to match NodeCs
    *(volatile int*) (ispic_base_addr+ 0x04) = 0x2F094000; //ACBW=2, all neighbors valid, address is (AC=0, X=1,Y=1), bridge_write_en is 1, all else is 0

    // Weights and biases
    float fc_bias[FC_SIZE] = {-0.19517088, -0.18505685, -0.1291927, -0.2903587, 0.008134691, -0.05915707, -0.3281125, 0.23999739, 0.685388, 0.23259677, -0.30250922, 1.0635718, 0.18424535, -0.16849542, -0.107864015, 0.20332757, 0.7650558, -0.02722607, -0.20682648, 0.23651469, -0.017433032, -0.40557107, 0.777741, -0.16867028, 0.80621886, -0.44696638, -0.2170074, 0.10978377, 0.26479957, -0.22514854, 0.29302633, 0.29650995};
    float output_weights[CONV_OUTPUT_SIZE_X * FC_SIZE]={0.17867725, 0.24517947, -0.31480825, 0.6939295, -0.5481411, 0.35329, -0.42158198, -0.14325957, -0.5978293, -0.15209346, 0.2847202, -0.7302808, -0.26177642, 0.48397198, 0.42691413, -0.22134219, -0.5284336, 0.44969326, 0.037955295, -0.3248337, -0.91767573, 0.49602824, -0.5624204, 0.15208691, -0.5351782, 0.7002805, 0.84650856, 0.3528082, -0.13809654, 0.27441847, -0.7865415, 0.5742218};  // Example output weights
    float output_bias[OUTPUT_SIZE] = {-0.25280043};
    float fc_weights[CONV_OUTPUT_SIZE_X * FC_SIZE]={-0.22997664, 0.21216838, -0.2769255, -0.17898735, -0.22763675, 0.03168169, -0.3631484, -0.5528496, -0.018923722, 0.21001141, -0.16589929, 0.06184812, 0.2571312, 0.046733946, 0.13387209, 0.15274306, 0.048339054, 0.09832425, 0.13335617, 0.2141941, 0.23258619, 0.26640105, -0.4973186, -0.005897324, 0.082723744, 0.03961935, -0.74107915, -0.14879864, -0.21973188, -0.05650026, -0.16408037, -0.2153077, 0.079603575, 0.08110669, -0.037834622, -0.22481386, -0.19039872, 0.17077596, 0.096405186, 0.085063785, -0.18722403, 0.12743685, -0.062572695, -0.009443436, 0.18642004, -0.1293405, 0.15459962, 0.24152264, -0.24023548, -0.024345782, 0.16468109, 0.19441685, -0.19124109, -0.08333118, -0.21088105, 0.019141214, 0.0084276665, 0.05391246, -0.9282082, -0.21939091, 0.12809059, 0.12251269, 0.072521605, -0.056713905, 0.21591556, 0.12227986, 0.2789426, 0.13050978, 0.12271087, 0.28832033, 0.15911575, -0.066528976, -0.64349, 0.07410784, 0.060063463, -1.6712631, -0.06517081, -0.05618634, -0.1113028, -0.11612208, -0.45540622, 0.034796998, 0.23990609, 0.11440621, 0.18690594, -0.3306243, -0.019094314, 0.2645204, -0.17598309, -0.16482446, 0.06631723, 0.36519602, -0.17745765, -0.10241538, -0.28274915, 0.36626175, 0.005974832, 0.14874418, 0.448783, -0.07438404, 0.037177794, 0.18116611, -0.46669826, -0.095354065, -0.33644593, -0.09608817, -0.009039285, -0.29254085, 0.039523717, 0.047536604, -0.09726434, -0.21079673, 0.06816747, 0.04975454, 0.13630533, 0.22157939, -0.10246929, 0.13813756, -0.12647387, -0.17590775, -0.01050215, -0.14047937, -0.13993017, 0.06628422, 0.059301753, 0.177176, -0.36206514, -0.03364643, 0.09977242, 0.09258807, -0.23716664, 0.07425456, 0.07562475, -0.10589785, -0.89895606, 0.24458988, 0.18640846, -0.037813798, 0.089840524, 0.11944495, -0.018253352, 0.17310515, 0.12050754, 0.1471442, 0.049102116, 0.06585672, 0.004699834, -0.15597287, -0.095804155, 0.13050261, 0.1917931, 0.21279897, -0.31570956, 0.1214265, 0.4152777, -0.6823913, 0.31194997, 0.026246538, 0.27704516, -0.4128455, 0.052893784, -0.115096346, 0.009361467, 0.024622098, -0.12153788, -0.014243956, -0.4601068, 0.03126097, -0.0144842295, 0.22480576, 0.105208166, 0.0933351, -0.01840474, 0.13485174, -0.15318693, 0.069904745, 0.1492867, -0.49462718, 0.20911439, 0.17891951, 0.42899907, -0.056430634, -0.02127586, 0.2489763, 0.23076828, 0.20691948, -0.365122, -0.47683245, 0.12838155, 0.193247, 0.02787618, 0.1164414, 0.1224602, 0.10790643, 0.115640715, 0.30084255, -0.01741748, -0.3039969, -0.16984783, 0.109187, -0.061872, 0.16087173, 0.19474153, 0.09298373, 0.17149094, 0.1047359, 0.030789927, -0.14574043, 0.20622315, -0.24804315, 0.030953337, -0.11661917, -0.2370902, -0.10796953, -0.011095157, -0.061070375, -0.2165668, -0.24643251, -0.28526992, 0.1754045, -0.23740022, -0.009211947, -0.1483792, 0.062555015, 0.08122186, -0.13891326, -0.16302621, -0.550025, -0.5238261, -0.2947968, 0.18365894, 0.10585427, 0.11555779, -0.14417098, -0.08037114, -0.00023153506, 0.23396038, 0.08579653, -0.13776878, 0.046966277, 0.049432497, 0.3532742, -0.07609412, -0.12470506, -0.032439258, 0.22500147, 0.25080884, 0.3280268, 0.090759136, 0.17371248, -0.67459816, 0.16322568, 0.037723485, 0.19584319, -0.24469571, 0.2544106, -0.027551906, 0.10179487, 0.1226943, -0.59165484, -0.025936682, 0.0946002, -0.2521758, 0.1581225, -0.07255157, 0.23799151, 0.13562807, 0.03754428, -0.022852553, -0.4327242, -0.39336383, -0.017441943, 0.32332087, -0.06472212, -0.053107698, 0.28219444, -0.086793676, 0.36599782, 0.024148645, -0.24512362, 0.0509409, 0.1565133, 0.35809815, 0.19661613, -0.24636321, -0.018055974, -0.14412105, -0.018323664, -0.07502006, -0.20226437, 0.21234907, 0.30950293, -0.44048885, -0.08328442, -0.34808257, -0.11926019, -0.12451159, -0.083416276, 0.022556156, 0.18475424, 0.19454135, -0.20801239, -0.16538328, -0.01750393, 0.13473852, -0.049289685, -0.26014677, -0.106509216, 0.30379692, 0.03900851, -0.08758628, -0.73928815, -0.19965106, 0.075903386, 0.13949598, 0.23906566, -0.14407863, -0.22084972, -0.1029551, -0.46032897, 0.27008334, 0.08402097, -0.21065709, 0.2211712, 0.14537735, 0.16294523, -0.15458322, -0.08562668, -0.21112719, 0.12967615, -0.108369306, 0.1571623, 0.28217548, -0.18236487, 0.026253935, -0.054621406, 0.007567778, 0.16905203, -0.15348883, 0.1318776, -0.06183545, -0.28091145, 0.24014767, -0.045790315, 0.20644383, 0.066211976, -0.12142292, -0.10847989, 0.075801566, 0.15513466, -0.31105244, 0.06981754, -0.16613507, -0.16077206, -0.0024294138, 0.05445311, -0.015443985, -0.22631559, -0.23614131, -0.088088244, 0.01720775, 0.07811547, -0.10797883, 0.11894591, -0.051404253, 0.40605542, -0.23721449, 0.042746942, 0.068330325, 0.2002107, 0.037074536, -0.20571887, 0.021898234, -0.03359665, 0.087373845, -0.14252907, 0.29549167, -0.083430976, -0.22751363, -0.13106538, -0.09483045, 0.13003434, -0.29210147, 0.13487042, -0.14329553, 0.18767792, 0.14317012, -0.027465217, -0.18502353, -0.13247505, 0.21341829, -0.081419475, 0.14336649, -0.042075425, 0.37844142, -0.23663098, -0.16114078, 0.21416965, -0.13063653, -0.05216364, 0.07536327, 0.013961047, 0.15981613, 0.09621668, -0.06706263, 0.11341652, 0.12867126, 0.061771993, 0.121652804, -0.42277426, 0.072257124, 0.24864347, 0.2319759, -0.12931605, -0.47282377, -0.2574085, -0.0641308, -0.12770827, 0.0447186, 0.18627211, 0.19701104, -0.20950116, -0.0003923492, 0.07762247, 0.45853293, 0.06826005, -0.16883703, -0.00045759516, 0.061287593, 0.0227741, -0.12755002, 0.084373325, 0.08261852, 0.3983034, -0.2340173, -0.17848496, 0.08359578, 0.12709697, 0.14737253, -0.17505014, -0.39699712, -0.4768169, -0.1561118, -0.31780097, 0.0681489, -0.014734612, -0.14416414, 0.015187556, 0.16028336, 0.0737324, -0.2153048, 0.107574716, -0.256017, -0.27346954, 0.21548824, 0.08360703, 0.20419426, -0.104568765, 0.38289428, -0.084491774, -0.30119717, 0.1845018, 0.060087066, 0.0037824914, 0.06448366, -0.08468275, 0.30402774, 0.027623188, -0.31218565, -0.15765856, -0.104178965, -0.28148538, 0.2138731, -0.08931636, 0.18825771, 0.124282755, 0.1387162, 0.034453377, 0.17843488, -0.08371471, -0.23790191, 0.20941295, 0.2186685, 0.3953041, 0.10882401, 0.19947593, 0.098327056, 0.20298854, 0.3253005, -0.089075804, -0.45296288, 0.24681512, 0.027645575, 0.30208358, -0.03186535, 0.027827768, 0.017400736, -0.34349793, -0.0478857, -0.011081973, 0.4458948, 0.01679829, -0.40289086, -0.3282071, -0.04906609, 0.5359038, -0.69258136, -0.027650231, 0.23484887, 0.032023523, -0.16425477, -0.22871812, 0.37356642, 0.06565602, 0.019562345, -0.17730843, 0.1682659, 0.2337872, -0.05643917, 0.0022942862, 0.066428676, -0.1570196, -0.032478653, -0.07184414, 0.33336997, 0.15004802, 0.058131445, 0.107107006, -0.14732003, 0.26367375, 0.22639577, -0.0817636, 0.3140594, -0.28185144, 0.46743372, -0.040032253, -0.05070954, 0.05971431, -1.093155, -0.13530223, 0.14323586, -0.27445626, -0.09206258, -0.14490648, -0.093170896, -0.23629525, -0.07971035, 0.37941283, -0.36269, -0.0070604696, 0.13168938, -0.23084892, 0.11926844, -0.20392188, 0.13040401, 0.28343585, -0.14873, -0.3747463, -0.19962542, -0.14736117, -0.14094612, -0.03799887, -0.1255158, -0.08090282, -0.549597, -0.19669916, -0.17385362, 0.15059066, -0.029967254, -0.16001959, 0.14903899, 0.14860548, -0.10170097, -0.24555987, 0.2475096, -0.3339783, -0.25020313, -0.15894121, -0.7098418, 0.2307087, -0.2599912, -0.105019115, 0.044575065, 0.34996924, 0.12285483, -0.2057098, 0.14484608, 0.047744058, 0.15814734, -0.3273549, -0.16523328, -0.03564786, -0.061719783, 0.32270953, 0.044437487, 0.2963936, 0.103823274, -0.3173691, 0.0047418172, -0.07870642, -0.08236653, 0.33177644, 0.046583425, -0.057381377, -0.11367138, -0.1127531, 0.1530782, 0.28115752, 0.009547075, -0.0997256, 0.10743541, 0.06469219, 0.15091851, -0.120871305, -0.33816245, -0.3971608, 0.47174388, 0.10490899, 0.107808694, -0.23032118, 0.2542982, -0.27832496, 0.03383611, -0.3570109, 0.0032376545, -0.48813257, 0.19126937, 0.24494874, -0.35369694, 0.22635677, -0.24447781, -0.1636386, 0.21514729, -0.020783927, -0.56779706, -0.08951493, -0.012074839, -0.11533013, 0.01067466, 0.348283, -0.044150356, -0.35192457, 0.07260159, -0.2980239, -0.6418252, 0.22028752, -0.36299053, -0.31739908, -0.012922527, -0.10254885, 0.3636658, 0.12941745, 0.13586506, 0.17270814, 0.27748445, -0.016168177, 0.12623863, 0.24766837, -0.22182481, 0.0023545148, -0.4057536, -0.13011174, -0.11491982, 0.23472612, 0.26236087, -0.3545593, 0.081911355, 0.21868123, -0.39249727, 0.0391028, -0.120294094, -0.27895498, -0.34135574, -0.2001675, 0.22589038, 0.13962975, 0.36382064, 0.110615, 0.24898924, 0.20362571, 0.4446993, -0.013572716, 0.22376609, -0.3022798, 0.12321339, -0.31914705, 0.19753619, 0.2603668, -0.22715157, 0.21780287, 0.16609927, 0.21572728, 0.23684411, 0.28341964, 0.20758888, 0.079795316, 0.026356265, -0.41873667, 0.13367079, 0.38546714, 0.13748395, 0.20667778, 0.3424454, -0.1444894, -0.21974896, -0.23946388, -0.31662202, 0.29636633, 0.22791012, -0.07808042, -0.029644815, -0.014852487, 0.0057460195, 0.23572363, 0.091276266, -0.055208594, -0.15630649, 0.14281505, -0.06831475, -0.12885137, -0.224172, -0.11018771, 0.24390875, -0.03638399, -0.034702677, 0.17365971, 0.102720864, -0.024652408, -0.25825164, 0.07087911, 0.20592038, 0.2905064, 0.08686459, 0.052413568, -0.18049356, 0.17185643, 0.18413661, 0.24038348, 0.19705023, -0.09641791, 0.03942675, -0.07494026, 0.018911544, -0.13244309, -0.18567303, -0.24473134, 0.18175796, -0.009231338, -0.2158496, 0.23483236, -0.24321814, -0.1536711, 0.0060943887, 0.07055545, 0.2507387, 0.23649721, 0.2512231, 0.07423546, 0.25786507, 0.11286665, 0.13214587, -0.4870223, -0.34698337, -0.020359695, -0.040487044, 0.16773392, -0.2788659, -0.38827226, 0.27709943, 0.026086936, -0.12947023, 0.09265296, 0.09324205, 0.12027412, -0.020345895, 0.06559469, -0.050405484, 0.14160967, 0.2355025, 0.19881542, -0.26558906, 0.21619427, -0.8668763, 0.2545914, 0.22741203, 0.06776933, -0.19143686, -0.032799687, -0.29328856, -0.2288201, -0.10612633, 0.5471763, -0.15256688, -0.31907287, 0.111785926, -0.035225287, 0.20823908, 0.040874247, -0.018514693, -0.17773592, -0.071397565, -0.06986997, 0.44688782, 0.025569266, 0.21563675, 0.2523578, 0.2100114, 0.31372365, 0.26388624, -0.15282935, 0.18519673, 0.005829586, 0.23161559, -0.025594547, -0.5197273, -0.1621998, -0.10338524, -0.20102853, 0.17675301, -0.20270078, -0.3327485, 0.14991425, 0.12964906, 0.32548338, -0.23382476, -0.25160772, 0.42065158, -0.18244052, 0.06844353, 0.09958176, 0.11138072, -0.09487907, -0.14229116, -0.13450477, -0.12803127, 0.04586436, 0.36637256, 0.009035663, -0.026267707, 0.10251557, -0.20842507, -0.12286434, -0.06607885, -0.52761084, -0.007309467, 0.3203439, -0.20511898, -0.26381254, 0.25997794, 0.25042626, 0.25800553, -0.15270466, 0.39108852, -0.056698136, 0.2593162, 0.073871195, -0.008245617, 0.26932648, -0.13243115, 0.26200435, -0.12461601, 0.08002779, 0.24746111, -0.03797683, 0.019069528, 0.14759883, 0.14160438, -0.2536503, -0.2795589, 0.30906823, -0.20689999, -0.21238646, -0.015646778, -0.026983656, 0.2511831, 0.06879151, 0.026366659, 0.06308457, 0.08507213, -0.018823838, -0.2675807, -0.78969693, -0.1439935, 0.038740523, 0.05421283, -0.11781881, -0.13704875, 0.08012245, 0.059106197, -0.08886763, -0.63772345, -0.007755763, 0.19160289, -0.13336867, 0.2116553, -0.2762538, -0.11780265, 0.2639791, -0.11131848, -0.35826528, 0.13880983, 0.06642401, 0.1576252, 0.04121513, -0.19674142, -0.2207257, -0.22269842, 0.15649305, -0.20182763, 0.030129904, 0.5431488, 0.25597873, -0.101372726, -0.4487105, 0.09090975, -0.03695777, 0.06283581, 0.16612165, 0.11351318, 0.08741386, -0.121327385, -0.21330832, -0.5880186, 0.16432203, -0.1511973, -0.19472511, 0.14139262, 0.24823563, -0.08862426, 0.12537119, -0.19837266, -0.36287823, -0.49499908, -0.044023424, -0.045451336, -0.19705808, 0.21939364, 0.30725098, 0.14690152, -0.11908673, -0.112031065, -0.38136345, 0.09381999, -0.0025448848, -0.26348934, -0.11442855, 0.12085088, 0.16941348, -0.7559544, -0.019837402, -0.05473059, 0.010668904, -0.0024444477, -0.3040369, -0.8158807, 0.017058767, 0.26673922, 0.08381714, 0.15503325, -0.16946274, 0.14420696, 0.15920787, -0.116122015, 0.21272703, 0.016670302, 0.04812053, -0.23475246, -0.0071817343, 0.2703682, 0.12212181, 0.1317993, 0.15353572, 0.08606098, -0.53975254, -0.115039565, -0.35091856, -0.12301827, -0.10331527, -0.08942101, -0.26813966, -0.58983463, 0.010105899, -0.036168903, 0.19874537, 0.004066978, -0.29900646, -0.21349603, 0.06425458, -0.021797927, -0.10561893, -0.31278402, 0.025108395, -0.028142635, 0.19394295, 0.16220675, -0.15548079, -0.19855477, -0.09925029, -0.3555376, -0.077884756, 0.043835465, 0.04517793, 0.097468674, -0.06798559, -0.35000318, 0.013557574, -0.41558045, -0.26719046, 0.20504132, -0.10137501, 0.22790907, -0.048903752, -0.8821203, 0.013063603, -0.19935836, -0.120760836, 0.2973315, -0.2777652, 0.2039063, 0.010470495, -0.003142277, -0.013543317, 0.10626271, 0.07711663, 0.07091873, 0.17199844, 0.027282078, -0.18673398, -0.1358865, 0.03810833, -0.24276848, -0.21449986, -0.15682565, 0.2445237, 0.04152415, -0.1223163, -0.17929648, -0.30862573, 0.026302572, 0.2644774, 0.2730459, -0.35451493, -0.14220242, 0.10133173, -0.15294498, -0.058409214, 0.26689893, -0.045795634, -0.3641949, -0.38825673, 0.025412394, 0.12913585, 0.04821482, 0.2535515, 0.048594113, 0.2704708, 0.007596985, 0.022445384, -0.01647468, 0.17243837, 0.2648106, 0.37079793, -0.014667395, 0.0194358, -0.29665396, -0.16372028, -0.10165602, 0.22841068, -0.26057297, 0.038636826, -0.13649237, -0.0687255, 0.09777709, -0.059918683, -0.10969745, 0.119070634, 0.24710098, -0.2029006, 0.03284609, -0.23515417, -0.39203566, 0.050963536, -0.3639151, 0.12637095, 0.18989459, -0.11152879, -0.04591107, -0.39534467, 0.26408178, 0.22592464, -0.16604178, 0.31379044, -0.47151682, 0.071155615, 0.43814823, 0.0006429504, 0.2329322, 0.26056576, 0.15080906, -0.18059051, -0.22674488, 0.09734526, 0.15119144, -0.05649789, -0.00050704833, 0.035963215, -0.11918835, 0.041027773, 0.24985316, -0.2265566, 0.15896298, -0.50473857, 0.0077675693, -0.21875347, 0.034227706, 0.26012957, 0.38691896, 0.06862922, -0.18066372, -0.03794784, 0.16565084, 0.118045755, -0.054536447, 0.051329266, 0.024955425, 0.1771504, -0.10320676, 0.26775652, 0.15200451, -0.012994705, 0.15284784, 0.12203482, 0.01883698, -0.43827933, -0.17254268, 0.012103958, -0.24850428, 0.15369551, -0.2705817, -0.058589615, -0.63381785, -0.08887605, 0.288136, -0.08759386, 0.43352294, -0.17954473, -0.18969595, 0.37829387, 0.070471756, 0.07189001, 0.09984598, -0.15975147, -0.01990967, 0.06346498, -0.100574635, 0.16524258, -0.18758045, 0.012788291, -0.1181638, -0.15690368, -0.25617835, 0.26946694, -0.0054881508, 0.0409285, -0.06917234, -0.17926304, -0.08195961, -0.16415244, 0.10620408, 0.20757489, -0.26794258, -0.069504976, -0.22312051, -0.03586195, 0.061770905, 0.22011872, 0.09671675, 0.26536155, 0.033542246, 0.028447455, -0.11441777, -0.022033885, -0.12073612, -0.11806035, -0.06336497, 0.05664853, -0.039215866, -0.2145451, 0.29256546, 0.14483696, -0.050569993, 0.023798632, 0.1792289, -0.19773062, 0.23477978, -0.16578156, -0.2737324, -0.41192466, 0.12542456, 0.119748, -0.14057581, -0.039418824, 0.16095713, -0.075864, 0.31767613, 0.05573129, -0.040794577, -0.03461014, 0.20449726, 0.05279741, 0.22028907, 0.15287977, -0.2818308, -0.22413258, 0.3755204, -0.14829771, 0.029629126, 0.10490715, -0.35261506, 0.18972048, 0.18629293, 0.38388488, -0.22067781, 0.07589853, 0.4114467, -0.20656702, -0.05529087, -0.13889112, 0.16261354, 0.0048271287, 0.0051480955, 0.107172884, -0.1635401, -0.36226177, -0.08439993, -0.20309605, 0.2304012, -0.23027079, 0.09377515, -0.40631825, 0.061228365, 0.30989403, -0.29722232, 0.28315273, -0.21749967, -0.23653676, -0.26765528, 0.2711707, 0.10516888, 0.1703208, 0.2751537, -0.0797994, 0.38677874, -0.056739926, -0.34712765, -0.0999828, 0.23977274, -0.14842121, 0.1953124, 0.1250825, 0.086838454, 0.113421895, -0.27991498, 0.020322733, 0.21822871, -0.056873087, -0.14255394, 0.1351933, -0.25009498, -0.097417, 0.29098886, -0.44512695, -0.0027193741, -0.31096995, 0.05099109, -0.41882196, 0.0862817, 0.012097473, -0.38049176, 0.35678914, 0.2580467, 0.19086762, 0.22980407, 0.22989607, -0.14603996, -0.017700229, 0.06505551, -0.32837474, -0.094025105, -0.022816036, 0.37630773, -0.05165144, -0.027144888, -0.0030146313, 0.3171234, -0.0041976445, -0.11411692, 0.27173552, 0.3768827, -0.12048387, -0.6895421, 0.18890168, 0.3534099, 0.22325629, -0.27319163, -0.184243, 0.44285092, 0.18669462, 0.05253532, 0.07336164, -0.2434379, -0.06613124, -0.109640665, -0.25939402, 0.36055648, 0.0009941732, -0.30223635, -0.15212125, 0.004209801, -0.3812185, -0.093736835, 0.07878791, 0.26919717, 0.071932405, 0.042634197, -0.35107425, 0.269649, 0.10570909, -0.059534308, 0.057164326, -0.16402692, 0.035627585, -0.45628452, -0.30937573, -0.19845006, -0.15644424, 0.21809216, -0.19255657, 0.2089983, -0.24353398, 0.18926857, -0.29065946, -0.1526244, 0.105645366, -0.23168163, 0.28382784, 0.18216464, -0.032472257, -0.24158858, -0.30191362, -0.07687823, 0.010207146, -0.06299289, -0.0057039843, 0.045075007, 0.083532386, -0.054989785, -0.09419289, 0.3664222, 0.14843217, -0.20087318, 0.10342979, 0.07379172, 0.046020687, -0.25355947, 0.058684506, -0.04335107, 0.075961426, 0.033465464, 0.58819383, -0.1305726, 0.03904071, -0.081241384, -0.08967311, 0.2824556, 0.122591846, -0.030273557, -0.20440419, -0.38026425, -0.27513537, 0.28786823, 0.18448877, 0.0062950947, 0.21958712, -0.12262444, -0.187571, -0.32805732, 0.3481877, -0.08486081, -0.34239203, 0.07730273, 0.07250384, -0.25801256, 0.022491233, 0.15230888, -0.17717218, -0.14056262, 0.26295376, 0.21304485, -0.03617189, 0.11385547, 0.11471498, -0.27025068, 0.10330901, -0.107044496, 0.12470416, 0.33703086, -0.13503456, -0.028622627, -0.2538008, 0.08449438, 0.514383, -0.27735266, -0.1469887, 0.102988705, 0.31370297, -0.056935642, 0.16978239, 0.09183683, -0.12501654, -0.073803246, 0.17398599, 0.24485025, 0.05997649, -0.13355018, 0.34217945, -0.16776757, 0.0020585791, -0.1435381, 0.13923332, -0.1935061, 0.3813256, -0.02488429, 0.10233264, -0.068741806, 0.1680091, -0.09046688, -0.1170713, -0.4540269, -0.14676511, -0.2427538, 0.12655017, 0.26721984, 0.28765386, -0.31515616, 0.08664698, 0.06118762, -0.19372585, -0.11235485, -0.00014656414, -0.19743425, 0.6043322, -0.12708475, 0.09168641, 0.07139955, -0.10226291, -0.19740622, 0.32737863, 0.052936155, -0.057956394, -0.0031938632, -0.06428718, -0.1225643, 0.019890374, 0.28658298, -0.07465496, 0.43862984, 0.04453441, 0.28020293, -0.013030324, 0.32152632, -0.15369765};

    // Output arrays
    float fc_output[FC_SIZE];
    float output[OUTPUT_SIZE];
	while(1)
		{

    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d1;
		    receive_float_from_MCU1();
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d2;
		    // Perform fully connected layer with ReLU
		    fully_connected_relu(conv_output, fc_weights, fc_bias, fc_output, CONV_OUTPUT_SIZE_X, FC_SIZE);
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d3;
		    // Perform fully connected layer with Sigmoid
		    fully_connected_sigmoid(fc_output, output_weights, output_bias, output, FC_SIZE, OUTPUT_SIZE);
    		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xA11900d4; 
		    *(volatile int *) (spi_sub_base_addr + 0x4) = *(uint32_t*)&output[0];
			    // -------------------- SEND DATA --------------------
				*(volatile int*) (ispic_base_addr + 0x14) = *(uint32_t*)&output[0]; //data
				*(volatile int*) (ispic_base_addr + 0x34) = 0x00000009; //routing_path_in_0_0 = 00001001 or ac0, x=1, y=1
				*(volatile int*) (ispic_base_addr+ 0x0C) = 0x1A030003; //Instruction 02 (normal write) to address 3 but from fourth direction
				*(volatile int*) (ispic_base_addr+ 0x0C) = 0x1A030002; //Remove Flag 
				// Simple delay
				delay(100);
		    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xFFFFFFFF;
		}
    *(volatile int *) (spi_sub_base_addr + 0x4) = 0xFA11900D; 
    return 0;
}

